<!DOCTYPE html>
<html lang="pl">
<head id="head1" runat="server">
    <meta charset="utf-8" />
    <link rel="stylesheet" href="stylelogowanie.css" type="text/css" />
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <script type="text/javascript">


        async function logIn() {
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");

            var raw = JSON.stringify({
                "email": document.getElementById("login").value,
                "password": document.getElementById("password").value
                // "email": "test@abc.pl",
                //"password":"test1234"
            });

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw,
                redirect: 'follow'
            };

            fetch("https://localhost:7259/api/token", requestOptions)
                .then(response => {
                    if (response.ok) {
                        reCaptcha()

                        localStorage.setItem("email", document.getElementById("login").value);
                        return response.text()
                            .then(data => {
                                document.cookie = `access_token=${data}`
                                localStorage.setItem("tokenik", data);
                                console.log(document.cookie);
                                window.location.href = "https://localhost:7259/api/user/admin"
                            })
                        
                    }
                })
        }

        let wynik;
        async function getRandom() {
            sessionStorage.setItem("email", document.getElementById("login").value);

            const random = Math.floor(Math.random() * 50);
            const email = sessionStorage.getItem("email");

            document.getElementById("randomNumber").innerHTML = random;
            document.getElementById("emailLenght").innerHTML = email;



            wynik = (email.length * Math.sin(random));
            document.getElementById("totpPass").value = wynik.toPrecision(2);
            console.log(wynik.toPrecision(2));


        }

        function oneTimePass() {

            if (document.getElementById("password").value == wynik.toPrecision(2)) {
                window.location.replace("https://localhost:7259/api/user/user");
            } else alert("Podano niepoprawne haslo");

        }



        function redirect() {
            window.location.replace("https://localhost:7259/api/user/homepage")
        }
    </script>


</head>
<body>

    <div id="srodek">
        <h1>Logowanie do aplikacji</h1>

        <b>Login</b> <input type="text" id="login" />
        <br>
        <br>
        <b>Hasło</b> <input type="password" id="password" />
        <br>
        <br>
        <input type="submit" value="Zaloguj" onclick="logIn()" />
        <div style="margin:auto;color:black;">
            <br>
            <div>
            </div>
            <br>

            <div class="g-recaptcha" data-sitekey="6LfWQ2wjAAAAANqptvW8yjVKArnt3sQHjXWRvtMC"></div>
            <input type="submit" value="submit" onclick="reCaptcha()" />
        </div>
        <div id="wynik"></div>
    </div>

   
    <script>
        function reCaptcha() {
            var response = grecaptcha.getResponse();
            if (response.length === 0) {
                // Wartość response jest pusta, co oznacza, że użytkownik nie przeszedł testu ReCaptcha
                alert("Proszę przejść test ReCaptcha");
                return 0;
            } else {
                var responseToken = response;
                console.log(responseToken)
                var requestOptions = {
                    method: 'POST',
                    redirect: 'follow'
                };

                var requestOptions = {
                    method: 'POST',
                    redirect: 'follow'
                };

                fetch("https://localhost:7259/api/captcha?responseToken=" + responseToken, requestOptions)
                    .then(response => {
                        if (response.ok) {

                            alert("Gites!");
                            console.log(response.json)
                        } else alert(response.status)
                    })
                    .then(result => console.log(result))
                    .catch(error => console.log('error', error));

            }
        }
    </script>

</body>
</html>